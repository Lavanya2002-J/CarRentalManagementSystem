@model CarRentalManagementSystem.ViewModels.BookingViewModel

@{
    ViewData["Title"] = "Book a Car";
}

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
<link rel="stylesheet" href="~/css/BookingCreate.css" asp-append-version="true" />

<div class="container my-5">
    <div class="row justify-content-center">
        <div class="col-lg-10">

            <div class="card glass-panel rounded-3 overflow-hidden">
                <div class="panel-header p-4 text-center">
                    <h2 class="mb-0 fw-bold">Complete Your Booking</h2>
                </div>
                <div class="card-body p-4 p-md-5">
                    <div class="row">

                        <div class="col-md-6 border-end-md border-secondary border-opacity-25 pe-md-5">
                            <h4 class="mb-3 text-white">You are booking: @Model.CarName</h4>
                            <img src="@Url.Content("~/uploads/" + Model.CarImageFileName)" class="img-fluid rounded mb-3 car-summary-image" alt="@Model.CarName">

                            <ul class="list-group list-group-flush summary-list">
                                <li class="list-group-item d-flex justify-content-between">
                                    <strong><i class="bi bi-tag-fill me-2"></i>Model:</strong>
                                    <span>@Model.CarModel</span>
                                </li>
                                <li class="list-group-item d-flex justify-content-between">
                                    <strong><i class="bi bi-gear-fill me-2"></i>Transmission:</strong>
                                    <span>@Model.Transmission</span>
                                </li>
                                <li class="list-group-item d-flex justify-content-between">
                                    <strong><i class="bi bi-fuel-pump-fill me-2"></i>Fuel Type:</strong>
                                    <span>@Model.FuelType</span>
                                </li>
                                <li class="list-group-item d-flex justify-content-between">
                                    <strong><i class="bi bi-currency-dollar me-2"></i>Daily Rate:</strong>
                                    <span id="dailyRate" data-rate="@Model.DailyRate">LKR @Model.DailyRate.ToString("N2")</span>
                                </li>
                            </ul>
                        </div>

                        <div class="col-md-6 ps-md-5 mt-4 mt-md-0">
                            <h4 class="mb-3 text-white">Select Your Dates</h4>
                            <form asp-action="Create" method="post">
                                @Html.AntiForgeryToken()
                                <div asp-validation-summary="ModelOnly" class="text-danger mb-3"></div>

                                <input type="hidden" asp-for="CarID" />

                                <div class="form-group mb-3">
                                    <label asp-for="PickupDate" class="form-label fw-bold"></label>
                                    <input asp-for="PickupDate" id="pickupDate" class="form-control" placeholder="Select pickup date..." />
                                    <span asp-validation-for="PickupDate" class="text-danger"></span>
                                </div>

                                <div class="form-group mb-3">
                                    <label asp-for="ReturnDate" class="form-label fw-bold"></label>
                                    <input asp-for="ReturnDate" id="returnDate" class="form-control" placeholder="Select return date..." disabled />
                                    <span asp-validation-for="ReturnDate" class="text-danger"></span>
                                </div>

                                <hr class="border-secondary opacity-25" />

                                <div class="text-center my-3 p-3 total-cost-box">
                                    <h4 class="fw-bold text-white">Estimated Total</h4>
                                    <h2 id="totalCost" class="fw-bolder">LKR 0.00</h2>
                                </div>

                                <button type="submit" class="btn btn-primary btn-lg w-100 mt-3">
                                    <i class="bi bi-arrow-right-circle-fill me-2"></i>Confirm & Proceed to Payment
                                </button>
                            </form>
                        </div>

                    </div>
                </div>
            </div>
        </div>
    </div>
</div>


@section Scripts {
    @{
        await Html.RenderPartialAsync("_ValidationScriptsPartial");
    }

    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>

    <script>
        document.addEventListener('DOMContentLoaded', function () {
            // Get references to elements
            const pickupDateInput = document.getElementById('pickupDate');
            const returnDateInput = document.getElementById('returnDate');
            const dailyRateElement = document.getElementById('dailyRate');
            const totalCostElement = document.getElementById('totalCost');

            // Get the daily rate from the data attribute
            const dailyRate = parseFloat(dailyRateElement.getAttribute('data-rate'));
            let returnDatePicker = null;

            // Function to calculate and display the total cost
            function calculateTotal() {
                const pickupDate = pickupDateInput._flatpickr.selectedDates[0];
                const returnDate = returnDateInput._flatpickr.selectedDates[0];

                if (pickupDate && returnDate) {
                    const timeDiff = returnDate.getTime() - pickupDate.getTime();
                    // Ensure we count rental days correctly; e.g., picking up today and returning tomorrow is 1 day.
                    const dayDiff = Math.max(1, Math.ceil(timeDiff / (1000 * 3600 * 24)));

                    if (dayDiff > 0) {
                        const total = dayDiff * dailyRate;
                        totalCostElement.textContent = 'LKR ' + total.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
                    } else {
                        totalCostElement.textContent = 'LKR 0.00';
                    }
                } else {
                    totalCostElement.textContent = 'LKR 0.00';
                }
            }

            // Initialize Flatpickr for the pickup date
            flatpickr(pickupDateInput, {
                altInput: true,
                altFormat: "F j, Y",
                dateFormat: "Y-m-d",
                minDate: "today",
                onChange: function(selectedDates) {
                    const pickupDate = selectedDates[0];
                    if (pickupDate) {
                        // Enable and configure the return date picker
                        returnDateInput.disabled = false;

                        if (returnDatePicker) {
                            returnDatePicker.destroy(); // Destroy previous instance to reconfigure
                        }

                        returnDatePicker = flatpickr(returnDateInput, {
                            altInput: true,
                            altFormat: "F j, Y",
                            dateFormat: "Y-m-d",
                            minDate: new Date(pickupDate.fp_incr(1)), // Set min return date to day after pickup
                            onChange: calculateTotal
                        });
                        // Open the return date picker automatically
                        returnDatePicker.open();
                    } else {
                        // Disable return date if pickup is cleared
                        returnDateInput.disabled = true;
                        if(returnDatePicker) returnDatePicker.clear();
                    }
                    calculateTotal();
                }
            });
        });
    </script>
}